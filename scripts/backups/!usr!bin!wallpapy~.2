#!/usr/bin/python3.3
# -*- coding: utf-8 -*-

"""
wallpapy - Simple wallpaper changer that uses nitrogen as its backend

Usage:
    wallpapy [-d <directory>] [-t <timeout>]
    wallpapy -h | --help
    wallpapy --version

Options:
-h --help       Show this screen.
--version       Show version.
-d=<directory>  Directory which contains the wallpapers [default: ~/.wallpaper].
-t=<timeout>    Time when the next wallpaper schould be loaded in sec [default: 600].
"""

__author__ = 'Ricardo Band'
__copyright__ = 'Copyright 2014, Ricardo Band'
__credits__ = ['Ricardo Band']
__license__ = 'MIT'
__version__ = '1.0.0'
__maintainer__ = 'Ricardo Band'
__email__ = 'me@xengi.de'
__status__ = 'Development'

import os
import sys
import time

from docopt import docopt


def find_wallpapers(directory='~/.wallpaper'):
    """
    Find all wallpapers in the dir
    """
    extensions = ['jpg', 'jpeg', 'png', 'gif']
    files = os.listdir(os.path.expanduser(directory))
    # find all files and add a bool if its a image (has one of the allowed
    # extensions)
    walls = {f: any(f.endswith(e) for e in extensions) for f in files}
    # return only the ones that are true
    return [f for f,i in walls.items() if i]


if __name__ == '__main__':
    args = docopt(__doc__, version='wallpapy v{}'.format(__version__))
    if os.system('which nitrogen > /dev/null') > 0:
        sys.exit('This program needs nitrogen to be installed.')
    try:
        if os.path.isdir(os.path.expanduser(args['-d'])):
            wp_list = find_wallpapers()
        else:
            wp_list = find_wallpapers(args['-d'])
        while True:
            for w in wp_list:
                os.system('DISPLAY=:0.0 nitrogen --set-auto {}'.format(os.path.join(args['-d'], w)))
                time.sleep(float(args['-t']) if args['-t'] else 600)
    except KeyboardInterrupt:
        sys.exit(0)
